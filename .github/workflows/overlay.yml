name: build-overlay

on:
  schedule:
    # Daily at 04:00 Pacific (11:00 UTC)
    - cron: '0 11 * * *'
    # Weekly cross-check on Sundays at 05:00 Pacific (12:00 UTC)
    - cron: '0 12 * * 0'
  workflow_dispatch: {}

jobs:
  overlay:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run generate_feed_overlay
        run: PYTHONPATH=$(pwd) python scripts/generate_feed_overlay.py
        env:
          OVERLAY_OUT: docs/feed_overlay.json

      - name: Debug output (sample bodies)
        run: |
          python - <<'EOF'
          import json
          with open("docs/feed_overlay.json") as f:
              data = json.load(f)
          charts = data["charts"]
          sample = ["Sun","Moon","Mercury","Venus","Mars","Eris","Sedna","Lilith"]
          for who, chart in charts.items():
              print(f"\n=== {who} ===")
              for b in sample:
                  obj = chart["objects"].get(b)
                  if obj:
                      print(f"{b}: {obj['ecl_lon_deg']}° | source={obj['used_source']}")
          EOF

      - name: Weekly JPL cross-check
        if: github.event.schedule == '0 12 * * 0'
        run: |
          echo "Running Swiss vs JPL Horizons check..."
          python - <<'EOF'
          import json, math
          from scripts.sources import horizons_client, swiss_client
          from datetime import datetime, timezone
          when = datetime.now(timezone.utc).isoformat()
          majors = ["Sun","Moon","Mercury"]
          for b in majors:
              swiss = swiss_client.get_ecliptic_lonlat(b, when)
              jpl = horizons_client.get_ecliptic_lonlat(b, when)
              if swiss and jpl:
                  diff = abs(swiss[0]-jpl[0])
                  if diff > 180: diff = 360 - diff
                  print(f"{b}: Swiss={swiss[0]:.5f}, JPL={jpl[0]:.5f}, Δ={diff:.6f}°")
                  if diff > 0.01:
                      print(f"Adjusting {b} to JPL value in overlay...")
                      with open("docs/feed_overlay.json","r+",encoding="utf-8") as f:
                          data=json.load(f)
                          for who in data["charts"]:
                              if b in data["charts"][who]["objects"]:
                                  data["charts"][who]["objects"][b]["ecl_lon_deg"]=jpl[0]
                                  data["charts"][who]["objects"][b]["used_source"]="jpl-corrected"
                          f.seek(0); json.dump(data,f,indent=2); f.truncate()
          EOF

      - name: Commit updated overlay
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci(overlay): refresh feed_overlay.json'
          file_pattern: docs/feed_overlay.json
