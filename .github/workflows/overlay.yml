name: build-overlay

on:
  schedule:
    # Run daily at 04:00 Pacific (11:00 UTC)
    - cron: '0 11 * * *'
  workflow_dispatch: {}

jobs:
  overlay:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run generate_feed_overlay
        run: PYTHONPATH=$(pwd) python scripts/generate_feed_overlay.py
        env:
          OVERLAY_OUT: docs/feed_overlay.json

      - name: Debug output (check Sun/Moon/Mercury)
        run: |
          echo "Checking generated feed_overlay.json..."
          python - <<'EOF'
          import json
          with open("docs/feed_overlay.json", "r", encoding="utf-8") as f:
              data = json.load(f)
          charts = data.get("charts", {})
          for who, chart in charts.items():
              if "objects" in chart:
                  objs = chart["objects"]
                  for body in ["Sun", "Moon", "Mercury"]:
                      if body in objs:
                          print(f"{who} - {body}: {objs[body]['ecl_lon_deg']}Â° | source={objs[body]['used_source']}")
          EOF

      - name: Commit updated overlay
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci(overlay): refresh feed_overlay.json'
          file_pattern: docs/feed_overlay.json
